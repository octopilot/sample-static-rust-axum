name: CI

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]
    workflow_dispatch:

jobs:
    detect:
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.detect.outputs.matrix }}
            languages: ${{ steps.detect.outputs.languages }}
            go-version: ${{ steps.detect.outputs.go-version }}
            rust-version: ${{ steps.detect.outputs.rust-version }}
            node-version: ${{ steps.detect.outputs.node-version }}
            python-version: ${{ steps.detect.outputs.python-version }}
            java-version: ${{ steps.detect.outputs.java-version }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Detect Contexts
              id: detect
              uses: octopilot/actions/detect-contexts@main

    lint:
        needs: detect
        if: needs.detect.outputs.languages != ''
        uses: octopilot/octopilot-workflows/.github/workflows/lint.yml@main
        with:
            languages: ${{ needs.detect.outputs.languages }}
            go-version: ${{ needs.detect.outputs.go-version }}
            rust-version: ${{ needs.detect.outputs.rust-version }}
            node-version: ${{ needs.detect.outputs.node-version }}
            python-version: ${{ needs.detect.outputs.python-version }}
            java-version: ${{ needs.detect.outputs.java-version }}

    test:
        needs: detect
        if: needs.detect.outputs.matrix != '[]'
        strategy:
            matrix:
                include: ${{ fromJson(needs.detect.outputs.matrix) }}
        uses: octopilot/octopilot-workflows/.github/workflows/test.yml@main
        with:
            language: ${{ matrix.language }}
            version: ${{ matrix.version }}
            context: ${{ matrix.context }}

    build-ephemeral:
        needs: [detect, lint, test]
        uses: octopilot/octopilot-workflows/.github/workflows/build-ephemeral.yml@main
        with:
            ttl: "2h"
            # We could matrix this too if we wanted separate images per artifact, but build-ephemeral builds everything by default via `op build`.
            # Actually `op build` builds everything in skaffold.yaml.
